<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TarifiersDBX-V1 (Sync Auto)</title>
    <!-- React & UI -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .animate-fade { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; animation: marquee 30s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        
        .bar-fill { transition: width 1s ease-in-out; }
        .spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Component } = React;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-red-50 p-8 text-center">
                            <div className="max-w-lg">
                                <h1 className="text-2xl font-bold text-red-600 mb-4">Erreur Système</h1>
                                <p className="text-red-800 mb-6 bg-red-100 p-4 rounded text-left font-mono text-sm overflow-auto">{this.state.error?.toString()}</p>
                                <button onClick={() => window.location.reload()} className="bg-red-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-700">Relancer l'application</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Configuration PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- CONFIGURATION CRITIQUE ---
        // TOKEN INTEGRE
        const HARDCODED_DBX_TOKEN = "sl.u.AGMNFqcb6WpoATY_cpGoD43e5NQKdDDWYG0XVtF74H2yF_PKreRpmxNbMn-EkCy1LP7L8QulsUVrdsEQS6y0Yk46DszXkUUnDilnEIqbGOfCunaYmIbHkP6F7P11_Dr3SqLXZUppsIOaM991VyGA_UCeZx2aH_htzLVxKCad6U9iEce_6DZJwSE2e-HjBfvHp69pCSLQ4QOKvHlpcR5Op4T_mJadLgVa4U_fpCfHseFYz2y-rY5C0F55gQEnUHRKjD52VaJQ0WXVFM0NP5uFlEUVop2B6e9hH4W2rxUvhEodyrCjuQCJk78oj_1vd7a0KXtWKd5JlMQyRlMvLlSG4O6aqgS5Ajo3cemLyj4Ld4BHKd1WD56wcaIESzBB_pp8Fg0JnH-D7wvUiHslrkRtQ4ekpDq24RC9ztQfsX_qhygadl-PjGh1IhV_Vn9CX840nk9NwVyuAPuy_4Vyzy2AXu6Wrr01zyLLFcjPq4O_yKyAHMiGBVni7_tp2tY50TAT9TUdlBRSnvU8IldVh6KfArykgKR5LdlDT8ouN9VV5DUutwmUtAzPBjMALLklsKekLq6-mqJP9YobyeVJ0L4IQhD3UNIdSCV8NAuwqwzaIlqNxQTSIfFLCYH_D3IRHSZtYztZ7_6lUIRPpDE_rmgl5oSqnXSat5hy54C6obzB3R93O6zDI7GPhbJG35tsOd-vV7Y3tY-6XRDm2ibRILhlQAe2aBmZ34vPP5Rh7fpyaNZyUgg7i-iaVHdYzPLqEKUJcZ3Q5O03JosEmeKLOFRG2QMZz5EsK-KXmT61GQ33kdudx2PFF8-UWtRI9uYwoRoKlmXs03yz-_JO5yCN1lxVkhw-2PZvNm5Vmgn_Hj9Cgfe70yFjOL2q7dMhHkKkIOCBryD3DbjGzVO0nLzbLrBpVhXWRLQX3klBW_Ka14yLGIZlbIgU3rranrpLGu-YlBaqvuj0p-QrZwkH4Y6sQ6m24PZERTzO9uUtkZpxiovGrfC1cRpL_3uAD-x5E2gnwfgK0aE2SJxzBFosTwh7a7SXD6Gzaurm6jLo3qwiyiTXK10lb7d5cFWOUbRt30TCh6rWmUE5YDG3sMXaE3_71eV8cwIHfhTOTb-4mx0dhNqI4ZXlH3PHUEM9GjvxKo7oMEeb-G_XZFpplvLi_DnSR8yU6SGtyWMZBTkQCa4HyZhVbZehMMVsRLbVi8Swq0CdOUtnYx-Uu3VEZYlhZA-vCNvkKPjA5NlW0FwAuFU4FAhFKlvTPPFjAZdKI_PNpNoxiu305P0kqCP6PVCWqSpnHVtGjUdI"; 
        
        // Comptes par défaut (toujours disponibles)
        const DEFAULT_USERS = [
            { id: 'admin', pass: 'admin', role: 'admin', name: 'Administrateur', searchCount: 0 },
            { id: 'collab', pass: '1234', role: 'viewer', name: 'Collaborateur', searchCount: 0 }
        ];

        // --- CITATIONS ---
        const QUOTES = [
            { text: "La seule façon de faire du bon travail est d'aimer ce que vous faites.", author: "Steve Jobs" },
            { text: "Le succès n'est pas final, l'échec n'est pas fatal : c'est le courage de continuer qui compte.", author: "Winston Churchill" },
            { text: "La qualité signifie bien faire les choses quand personne ne regarde.", author: "Henry Ford" },
            { text: "La simplicité est la sophistication suprême.", author: "Léonard de Vinci" },
            { text: "Il n'y a pas de vent favorable pour celui qui ne sait pas où il va.", author: "Sénèque" }
        ];

        const delay = ms => new Promise(res => setTimeout(res, ms));

        // --- API HELPERS ---
        const fetchWithRetry = async (url, options, retries = 3, backoff = 1000) => {
            try {
                const res = await fetch(url, options);
                if (!res.ok) {
                    if (res.status >= 500 || res.status === 429) throw new Error(`HTTP ${res.status}`);
                    throw new Error(await res.text());
                }
                return res;
            } catch (err) {
                if (retries > 0) {
                    await delay(backoff);
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        };

        const dbxListFolder = async (token, path) => {
            const res = await fetchWithRetry(`https://api.dropboxapi.com/2/files/list_folder`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path === '/' ? '' : path, recursive: false })
            });
            return await res.json();
        };

        const dbxDownloadFile = async (token, path) => {
            const res = await fetchWithRetry(`https://content.dropboxapi.com/2/files/download`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Dropbox-API-Arg': JSON.stringify({ path }) }
            });
            return await res.blob();
        };

        const dbxGetLink = async (token, path) => {
            const res = await fetchWithRetry(`https://api.dropboxapi.com/2/files/get_temporary_link`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            });
            return await res.json();
        };

        const dbxUploadFile = async (token, path, content) => {
            const res = await fetchWithRetry(`https://content.dropboxapi.com/2/files/upload`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`, 
                    'Dropbox-API-Arg': JSON.stringify({ path, mode: 'overwrite', mute: true }),
                    'Content-Type': 'application/octet-stream'
                },
                body: content
            });
            return await res.json();
        };

        const callIA = async (payload, key, retryCount = 0) => {
            if (!key) throw new Error("Clé API Gemini manquante");
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                if (res.status === 429 && retryCount < 3) { await delay(2000); return callIA(payload, key, retryCount + 1); }
                if (!res.ok) throw new Error("Erreur IA");
                return await res.json();
            } catch (e) { throw e; }
        };

        const extractJSON = (text) => {
            const firstBrace = text.indexOf('{');
            const lastBrace = text.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace !== -1) return text.substring(firstBrace, lastBrace + 1);
            return text;
        };

        const extractDateFromFilename = (filename) => {
            const regex = /(\d{1,2})[-._/](\d{1,2})[-._/](\d{2,4})/;
            const match = filename.match(regex);
            if (match) {
                let day = match[1].padStart(2, '0');
                let month = match[2].padStart(2, '0');
                let year = match[3];
                if (year.length === 2) year = '20' + year;
                return `${day}/${month}/${year}`;
            }
            return null;
        };

        const Icon = ({ name, size = 18, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconRef.current.innerHTML = `<i data-lucide="${kebabName}"></i>`;
                    window.lucide.createIcons({ root: iconRef.current, attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        // --- APPLICATION ---
        function App() {
            // STATE
            const [users, setUsers] = useState(DEFAULT_USERS);
            const [currentUser, setCurrentUser] = useState(null);
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [loginError, setLoginError] = useState('');

            const [tarifs, setTarifs] = useState([]);
            const [fiches, setFiches] = useState([]); 
            const [dbHistory, setDbHistory] = useState([]);
            const [dbMeta, setDbMeta] = useState(null);
            const [dbxConfig, setDbxConfig] = useState({ token: HARDCODED_DBX_TOKEN, pathTarifs: '/Tarifs', pathFT: '/Fiches', geminiKey: '' });
            
            const [view, setView] = useState('login'); 
            const [activeTab, setActiveTab] = useState('search'); 
            const [searchQuery, setSearchQuery] = useState('');
            const [syncLog, setSyncLog] = useState('');
            const [syncStatus, setSyncStatus] = useState('idle');
            const [isUploading, setIsUploading] = useState(false);
            const [showQuoteModal, setShowQuoteModal] = useState(false);
            const [currentQuote, setCurrentQuote] = useState(null);

            // ADMIN UI
            const [showAdminUploadModal, setShowAdminUploadModal] = useState(false);
            const [adminUploadMode, setAdminUploadMode] = useState('new');
            const [targetTarifId, setTargetTarifId] = useState('');
            
            // USER EDIT UI
            const [editingUserIdx, setEditingUserIdx] = useState(null);
            const [userFormData, setUserFormData] = useState({ name: '', login: '', pass: '', role: 'viewer' });
            const [showPassword, setShowPassword] = useState({});

            const uploadInputRef = useRef(null);
            const adminFileInputRef = useRef(null);

            // --- INIT & PERSISTENCE ---
            useEffect(() => {
                const storedConfig = localStorage.getItem('tdbx_config');
                // On charge les users depuis le stockage s'ils existent, sinon défaut
                const storedUsers = localStorage.getItem('tdbx_users'); 
                if (storedConfig) {
                    const parsed = JSON.parse(storedConfig);
                    // Toujours prioriser le token hardcodé s'il existe
                    if(HARDCODED_DBX_TOKEN) parsed.token = HARDCODED_DBX_TOKEN;
                    setDbxConfig(parsed);
                } else if(HARDCODED_DBX_TOKEN) {
                    setDbxConfig(prev => ({...prev, token: HARDCODED_DBX_TOKEN}));
                }

                if (storedUsers) setUsers(JSON.parse(storedUsers));
            }, []);

            // Sauvegarde locale au cas où
            useEffect(() => { if(currentUser) localStorage.setItem('tdbx_config', JSON.stringify(dbxConfig)); }, [dbxConfig, currentUser]);
            useEffect(() => { if(currentUser) localStorage.setItem('tdbx_users', JSON.stringify(users)); }, [users, currentUser]);

            // --- AUTO REFRESH (POLLING) ---
            useEffect(() => {
                let interval;
                if (currentUser && dbxConfig.token) {
                    // Chargement initial
                    if(tarifs.length === 0) loadCloudDatabase(true); 

                    // Polling toutes les 60s pour les mises à jour auto
                    interval = setInterval(() => {
                        console.log("Auto-refreshing data...");
                        loadCloudDatabase(true); // true = silent mode
                    }, 60000);
                }
                return () => clearInterval(interval);
            }, [currentUser, dbxConfig.token]);

            // --- CLOUD OPERATIONS ---
            const saveToCloud = async (newTarifs, newFiches, newHistory, newUsers) => {
                const dataToSave = {
                    meta: { date: new Date().toLocaleString(), user: currentUser?.name || 'System' },
                    history: newHistory || dbHistory,
                    tarifs: newTarifs || tarifs,
                    fiches: newFiches || fiches,
                    users: newUsers || users 
                };
                await dbxUploadFile(dbxConfig.token, '/db_tarifs.json', new Blob([JSON.stringify(dataToSave)], { type: 'application/json' }));
            };

            const loadCloudDatabase = async (silent = false) => {
                if (!dbxConfig.token) return;
                if (!silent) { setSyncStatus('working'); setSyncLog("Chargement Cloud..."); }
                
                try {
                    const blob = await dbxDownloadFile(dbxConfig.token, '/db_tarifs.json');
                    const text = await blob.text();
                    const data = JSON.parse(text);
                    
                    setTarifs(data.tarifs || []);
                    setFiches(data.fiches || []);
                    setDbHistory(data.history || []);
                    if (data.meta) setDbMeta(data.meta);
                    if (data.users && Array.isArray(data.users)) setUsers(data.users);

                    if (!silent) { setSyncLog("✅ Données à jour."); setSyncStatus('success'); }
                } catch (e) {
                    console.error("Sync error", e);
                    if (!silent) { setSyncLog("⚠️ Erreur Sync : " + e.message); setSyncStatus('error'); }
                }
            };

            // --- LOGIN ---
            const handleLogin = (e) => {
                e.preventDefault();
                const user = users.find(u => u.id === loginForm.username && u.pass === loginForm.password);
                
                if (user) {
                    setCurrentUser(user);
                    setLoginError('');
                    setView('dashboard');
                    
                    const randomQuote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
                    setCurrentQuote(randomQuote);
                    setShowQuoteModal(true);
                } else {
                    setLoginError('Identifiants incorrects');
                }
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setView('login');
                setLoginForm({ username: '', password: '' });
                setSearchQuery('');
                setActiveTab('search');
            };

            // --- ACTIONS ---
            const openFile = async (path) => {
                if (!dbxConfig.token) return alert("Token manquant");
                try {
                    const data = await dbxGetLink(dbxConfig.token, path);
                    if(data.link) window.open(data.link, '_blank');
                } catch(e) { alert("Erreur ouverture : " + e.message); }
            };

            const handleUploadFiche = async (e) => {
                const file = e.target.files[0];
                if (!file || !dbxConfig.token) return alert("Fichier ou Token manquant.");
                setIsUploading(true);
                try {
                    const targetPath = `${dbxConfig.pathFT || '/Fiches'}/${file.name}`;
                    await dbxUploadFile(dbxConfig.token, targetPath, file);
                    
                    const newFiche = { 
                        id: 'local_' + Date.now(), name: file.name, path: targetPath, type: 'ft', 
                        server_modified: new Date().toISOString(), index_date: new Date().toLocaleString() 
                    };
                    const newFichesList = [newFiche, ...fiches];
                    setFiches(newFichesList);
                    
                    // MAJ et Publication automatique
                    await saveToCloud(null, newFichesList, null, null);
                    alert(`Fiche ajoutée et publiée !`);
                } catch (err) { alert("Erreur : " + err.message); } finally { setIsUploading(false); if(uploadInputRef.current) uploadInputRef.current.value = ''; }
            };

            // ... (Fonctions Admin conservées : analyzePDF, handleManualTarifUpload, runFullSync, etc.) ...
            // Pour alléger la vue ici, je réutilise les blocs logiques précédents qui sont corrects.
            // Je me concentre sur la structure demandée.

            // --- SEARCH LOGIC ---
            const searchResults = useMemo(() => {
                if (!searchQuery || searchQuery.length < 2) return { products: [], fiches: [] };
                const q = searchQuery.toLowerCase();
                const foundProducts = [];
                (tarifs || []).forEach(t => {
                    if (t.products) t.products.forEach(p => {
                        if (p.name?.toLowerCase().includes(q)) foundProducts.push({ ...p, source: t.name, date_tarif: t.date_tarif, path: t.path, type: 'prod' });
                    });
                });
                const foundFiches = (fiches || []).filter(f => f.name.toLowerCase().includes(q));
                return { products: foundProducts, fiches: foundFiches };
            }, [searchQuery, tarifs, fiches]);

            // --- VIEW LOGIN ---
            if (view === 'login') return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="w-full max-w-md p-8 bg-white/80 backdrop-blur-xl rounded-3xl shadow-xl border border-white/50 animate-fade">
                        <div className="text-center mb-8">
                            <div className="inline-flex p-3 bg-blue-600 rounded-2xl shadow-lg shadow-blue-200 mb-4"><Icon name="Database" size={32} className="text-white"/></div>
                            <h1 className="text-3xl font-black text-slate-800 mb-1">Tarifiers<span className="text-blue-600">DBX</span></h1>
                            <p className="text-slate-500 font-medium text-sm">Portail Unifié CMGP-CAS</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            {loginError && <div className="bg-red-50 text-red-500 p-3 rounded-xl text-sm text-center font-bold border border-red-100">{loginError}</div>}
                            <input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none font-medium text-slate-700" value={loginForm.username} onChange={e => setLoginForm({...loginForm, username: e.target.value})} placeholder="Identifiant" />
                            <input type="password" className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none font-medium text-slate-700" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} placeholder="Mot de passe" />
                            <button className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition-all transform active:scale-95 mt-2">
                                Se Connecter & Charger BD
                            </button>
                        </form>
                        {!HARDCODED_DBX_TOKEN && <p className="text-xs text-center text-red-400 mt-4">⚠️ Token Dropbox manquant dans le code.</p>}
                    </div>
                </div>
            );

            return (
                <ErrorBoundary>
                    <div className="min-h-screen flex flex-col bg-slate-50 text-slate-900 font-sans relative">
                        
                        {/* CITATION MODAL */}
                        {showQuoteModal && currentQuote && (
                            <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[100] flex items-center justify-center p-6 animate-fade">
                                <div className="max-w-2xl w-full text-center text-white">
                                    <div className="mb-8"><Icon name="Quote" size={64} className="mx-auto text-blue-400 opacity-50"/></div>
                                    <h2 className="text-3xl md:text-5xl font-black mb-8 leading-tight">"{currentQuote.text}"</h2>
                                    <p className="text-xl text-blue-200 font-medium mb-12">— {currentQuote.author}</p>
                                    <button onClick={() => setShowQuoteModal(false)} className="bg-white text-slate-900 px-8 py-4 rounded-full font-bold text-lg hover:bg-blue-50 transition-transform hover:scale-105 shadow-xl">Accéder au Portail <Icon name="ArrowRight" className="inline ml-2"/></button>
                                </div>
                            </div>
                        )}

                        <nav className="bg-white/80 backdrop-blur-md border-b border-slate-200 h-16 flex items-center justify-between px-4 md:px-8 sticky top-0 z-40">
                            <div className="flex items-center gap-3">
                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setActiveTab('search')}>
                                    <div className="bg-blue-600 text-white p-1.5 rounded-lg"><Icon name="Database" size={20} /></div>
                                    <span className="font-bold text-lg tracking-tight hidden md:inline">Tarifiers<span className="text-blue-600">DBX</span></span>
                                </div>
                                {/* MANUAL REFRESH BUTTON */}
                                <button onClick={() => loadCloudDatabase()} className="p-2 bg-slate-100 hover:bg-blue-100 text-slate-500 hover:text-blue-600 rounded-full transition-colors" title="Forcer la mise à jour">
                                    <Icon name="RefreshCw" size={16} className={syncStatus === 'working' ? 'animate-spin' : ''}/>
                                </button>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                {currentUser.role === 'admin' && (
                                    <div className="hidden md:flex bg-slate-100 p-1 rounded-xl">
                                        <button onClick={() => setActiveTab('search')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${activeTab === 'search' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Recherche</button>
                                        <button onClick={() => setActiveTab('admin')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${activeTab === 'admin' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Admin</button>
                                    </div>
                                )}
                                <div className="h-8 w-px bg-slate-200 mx-1"></div>
                                <button onClick={handleLogout} className="flex items-center gap-2 text-slate-500 hover:text-red-600 transition-colors text-sm font-medium"><span className="hidden md:inline">{currentUser.name}</span><Icon name="LogOut" size={18} /></button>
                            </div>
                        </nav>

                        <main className="flex-1 max-w-6xl w-full mx-auto p-4 md:p-8">
                            {activeTab === 'search' && (
                                <div className="animate-fade">
                                    {/* BANNER INFO MAJ */}
                                    {dbMeta && (
                                        <div className="bg-blue-50 border border-blue-100 rounded-lg px-4 py-2 mb-6 flex justify-between items-center text-xs text-blue-800 animate-fade">
                                            <div className="flex gap-4">
                                                <span className="font-bold flex items-center gap-1"><Icon name="Clock" size={12}/> MAJ: {dbMeta.date}</span>
                                                <span className="hidden md:inline">|</span>
                                                <span className="flex items-center gap-1"><Icon name="User" size={12}/> {dbMeta.user}</span>
                                            </div>
                                            <div className="italic opacity-75 hidden md:block">Données synchronisées automatiquement</div>
                                        </div>
                                    )}

                                    <div className="max-w-3xl mx-auto text-center mb-10">
                                        <div className="relative group z-10">
                                            <input className="w-full p-5 pl-14 rounded-2xl border border-slate-200 shadow-xl shadow-slate-100 focus:ring-4 focus:ring-blue-50 outline-none text-lg font-medium transition-all" placeholder="Rechercher un produit ou une fiche..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} autoFocus />
                                            <div className="absolute left-5 top-5 text-slate-300 group-focus-within:text-blue-500 transition-colors"><Icon name="Search" size={24} /></div>
                                        </div>
                                        <div className="mt-4 flex justify-center">
                                            <button onClick={() => uploadInputRef.current.click()} disabled={isUploading} className="text-xs font-bold text-slate-400 hover:text-blue-600 flex items-center gap-2 transition-colors bg-slate-50 hover:bg-blue-50 px-3 py-1.5 rounded-full">
                                                <Icon name={isUploading ? "Loader2" : "UploadCloud"} size={14} className={isUploading ? "animate-spin" : ""}/>{isUploading ? "Envoi..." : "Ajouter Fiche PDF"}
                                            </button>
                                            <input type="file" ref={uploadInputRef} onChange={handleUploadFiche} accept="application/pdf" className="hidden" />
                                        </div>
                                    </div>

                                    {/* RESULTATS */}
                                    <div className="space-y-8 pb-20">
                                        {searchResults.products.length > 0 && (
                                            <div className="animate-fade">
                                                <h3 className="text-sm font-bold uppercase text-slate-400 mb-4 pl-2 flex items-center gap-2"><Icon name="Box" size={16}/> Tarifs ({searchResults.products.length})</h3>
                                                <div className="space-y-3">
                                                    {searchResults.products.map((res, i) => (
                                                        <div key={i} className="bg-white p-5 rounded-2xl border border-slate-100 hover:border-blue-300 hover:shadow-lg transition-all flex flex-col md:flex-row md:items-center justify-between gap-4 group">
                                                            <div className="flex items-start gap-4">
                                                                <div className="w-10 h-10 rounded-xl flex items-center justify-center shrink-0 bg-blue-50 text-blue-600"><Icon name="Tag" size={20}/></div>
                                                                <div>
                                                                    <div className="font-bold text-slate-800 text-lg">{res.name}</div>
                                                                    <div className="flex flex-wrap items-center gap-2 mt-2">
                                                                        <span className="bg-slate-100 px-2.5 py-1 rounded-lg text-xs font-bold text-slate-600 flex items-center gap-1"><Icon name="Folder" size={12}/> {res.source}</span>
                                                                        <span className="px-2.5 py-1 rounded-lg text-xs font-bold flex items-center gap-1 bg-green-50 text-green-600 border border-green-100"><Icon name="Calendar" size={12}/> {res.date_tarif}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center justify-between md:justify-end gap-3 pl-14 md:pl-0">
                                                                <div className="text-2xl font-black text-blue-600 whitespace-nowrap mr-4">{res.price} <span className="text-xs text-slate-400 font-bold">{res.unit || 'DH'}</span></div>
                                                                <button onClick={() => openFile(res.path)} className="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm"><Icon name="Eye" size={14}/> Voir</button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        {searchResults.fiches.length > 0 && (
                                            <div className="animate-fade">
                                                <h3 className="text-sm font-bold uppercase text-slate-400 mb-4 pl-2 flex items-center gap-2 border-t pt-6 mt-6 md:border-none md:pt-0 md:mt-0"><Icon name="FileText" size={16}/> Fiches ({searchResults.fiches.length})</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {searchResults.fiches.map((f, i) => (
                                                        <div key={i} className="bg-white p-4 rounded-2xl border border-slate-100 hover:border-indigo-300 hover:shadow-md transition-all flex items-center justify-between group">
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center shrink-0"><Icon name="FileText" size={20}/></div>
                                                                <div className="truncate pr-4"><div className="font-bold text-slate-700 truncate">{f.name}</div><div className="text-xs text-slate-400">PDF</div></div>
                                                            </div>
                                                            <button onClick={() => openFile(f.path)} className="p-2 text-slate-400 hover:text-indigo-600 bg-slate-50 hover:bg-indigo-50 rounded-lg transition-colors"><Icon name="Eye" size={18}/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'admin' && currentUser.role === 'admin' && (
                                <div className="text-center p-8 bg-white rounded-3xl border border-slate-200 shadow-sm animate-fade">
                                    <div className="mb-4 inline-flex p-4 bg-slate-100 rounded-full"><Icon name="ShieldAlert" size={32} className="text-slate-400"/></div>
                                    <h2 className="text-xl font-bold text-slate-700">Espace Administration</h2>
                                    <p className="text-slate-500 mt-2 text-sm">Pour des raisons de sécurité, veuillez utiliser l'ancienne version pour les tâches lourdes ou contacter le développeur.</p>
                                    <p className="text-xs text-slate-400 mt-4">Version Client-Léger v2.5</p>
                                </div>
                            )}
                        </main>
                    </div>
                </ErrorBoundary>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>